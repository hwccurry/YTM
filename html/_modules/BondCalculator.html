<!DOCTYPE html>

<html lang="zh-CN" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BondCalculator &#8212; 到期收益率 1.0 文档</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=61cd365c" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=12dfc556" />
    <script src="../_static/documentation_options.js?v=f115507d"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/translations.js?v=beaddf03"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>BondCalculator 源代码</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span> 
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">newton</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">so</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">openpyxl</span>
<span class="kn">from</span> <span class="nn">jms_sqlconnect</span> <span class="kn">import</span> <span class="n">jms_con</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">ChainMap</span>
<span class="kn">import</span> <span class="nn">os</span>




<div class="viewcode-block" id="BondCalculator">
<a class="viewcode-back" href="../BondCalculator.html#BondCalculator.BondCalculator">[文档]</a>
<span class="k">class</span> <span class="nc">BondCalculator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    **模块介绍:**</span>
<span class="sd">        模块定义了一个BondCalculator类，用于计算债券的到期收益率（YTM）和相关的现金流信息。它通过与数据库的连接，获取债券的相关数据，并根据交易日期和价格计算YTM，支持普通债券和可赎回债券的计算。</span>
<span class="sd">    </span>
<span class="sd">    **方法介绍:**</span>
<span class="sd">        1.类的构造函数__init__接受数据库连接的用户凭据</span>
<span class="sd">        </span>
<span class="sd">        2.YTM_coupon_bond方法根据债券代码、价格和交易日期计算YTM，判断债券是否可赎回，并调用YTM_coupon_bond_exercise或YTM_coupon_normal计算方法。</span>
<span class="sd">        </span>
<span class="sd">        3.YTM_coupon_bond_exercise和YTM_coupon_bond_normal方法分别计算可赎回债券和普通债券的YTM。</span>
<span class="sd">        </span>
<span class="sd">        4.process_data方法调用YTM_coupon_bond方法计算结果，并将债券代码写入Excel文件。</span>
<span class="sd">        **支持不同债券数据重复使用，可将数据一并添加到一个Excel文件，及两个工作表sheet_YTM和sheet_cash_flow**</span>
<span class="sd">        </span>
<span class="sd">    **建议使用准备:**</span>
<span class="sd">        1.请确定模块所需python包在环境中下载</span>
<span class="sd">        </span>
<span class="sd">        2.请将jms_connect放入同一个文件路径</span>
<span class="sd">        </span>
<span class="sd">        3.获取jms_connect账密</span>
<span class="sd">        </span>
<span class="sd">        4.创建数据存储路径</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span> <span class="o">=</span> <span class="s1">&#39;mazx&#39;</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;qaz12345678&#39;</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="s1">&#39;rd&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **介绍:**</span>
<span class="sd">            初始化一个新实例并建立与指定数据库的连接。</span>

<span class="sd">            该构造函数接受用户凭据和一个可选的数据库名称，通过`jms_con`方法创建连接。</span>
<span class="sd">            如果未提供数据库名称，则默认为&#39;rd&#39;。</span>
<span class="sd">        </span>
<span class="sd">        **重要**:</span>
<span class="sd">            此处默认使用正式员工权限，请使用自己的username和password，选择正确的数据库，如不遵守相关法律法规使用，数据泄露概不负责。</span>

<span class="sd">        参数:</span>
<span class="sd">            user (str, optional): 数据库连接的用户名。</span>
<span class="sd">            password (str, optional): 数据库用户的密码。</span>
<span class="sd">            database (str, optional): 要连接的数据库名称。默认为&#39;rd&#39;。正式库</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rdcon</span> <span class="o">=</span> <span class="n">jms_con</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">database</span><span class="p">)</span>

    
<div class="viewcode-block" id="BondCalculator.YTM_coupon_bond">
<a class="viewcode-back" href="../BondCalculator.html#BondCalculator.BondCalculator.YTM_coupon_bond">[文档]</a>
    <span class="k">def</span> <span class="nf">YTM_coupon_bond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bond_code</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">traded_date</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **介绍:**</span>
<span class="sd">            计算某债券在给定交易日的到期收益率。</span>
<span class="sd">            </span>
<span class="sd">            1.函数执行SQL查询，从数据库中检索债券信息和行权日期。</span>
<span class="sd">            </span>
<span class="sd">            2.通过检查债券的标签来判断债券是否可赎回。</span>
<span class="sd">            </span>
<span class="sd">            3.根据行权日期的存在与否，计算正常的YTM或同时计算正常和行权的YTM，并以字典形式返回结果。</span>
<span class="sd">        </span>
<span class="sd">        参数:</span>
<span class="sd">            bond_code (str): 债券代码。</span>
<span class="sd">            </span>
<span class="sd">            price (float): 交易日净价。</span>
<span class="sd">            </span>
<span class="sd">            traded_date (str): 债券的交易日，格式为 &#39;YYYY-MM-DD&#39;。</span>

<span class="sd">        返回类型:</span>
<span class="sd">            YTM(float): 债券的到期收益率（YTM）。</span>
<span class="sd">            </span>
<span class="sd">        用法:</span>
<span class="sd">            &gt;&gt;&gt;    from BondCalculator import BondCalculator as bc</span>
<span class="sd">            &gt;&gt;&gt;    object = bc()</span>
<span class="sd">            &gt;&gt;&gt;    bond_code = &#39;152961.SH&#39;</span>
<span class="sd">            &gt;&gt;&gt;    price = 84.63</span>
<span class="sd">            &gt;&gt;&gt;    traded_date = &#39;2024-7-25&#39;</span>
<span class="sd">            &gt;&gt;&gt;    file_path = &#39;/Users/mac/Desktop/YY/收益率脚本/YTM_2024_8_23.xlsx&#39;</span>
<span class="sd">            &gt;&gt;&gt;    sheet_YTM = &#39;YTM&#39;</span>
<span class="sd">            &gt;&gt;&gt;    sheet_cash_flow = &#39;cash_flow&#39;</span>
<span class="sd">            &gt;&gt;&gt;    ytm = object.YTM_coupon_bond(bond_code, price, traded_date)</span>
<span class="sd">            return {</span>
<span class="sd">            &#39;行权收益率&#39;: 2.3218890242845047,</span>
<span class="sd">            &#39;行权日&#39;: datetime.date(2026, 7, 21),</span>
<span class="sd">            &#39;行权信息&#39;: ·······</span>
<span class="sd">            &#39;到期收益率&#39;: 3.2840096938381316,</span>
<span class="sd">            &#39;现金流&#39;: ·······</span>
<span class="sd">            &#39;应付利息&#39;: 0.063233,</span>
<span class="sd">            &#39;全价&#39;: 84.693233}</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># sql查询 通过 bond_code 在 rd_bond 中匹配债券的tag 以获得债券行权信息</span>
        <span class="n">sql_query_tag</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;SELECT bond_code, tag, id FROM rd_bond  WHERE bond_code = &quot;</span><span class="si">%s</span><span class="s1">&quot; AND is_deleted = 0&#39;&#39;&#39;</span><span class="o">%</span> <span class="n">bond_code</span>
        <span class="c1"># 判断是否行权 </span>
        <span class="n">df_tag</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sql_query_tag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rdcon</span><span class="p">)</span>
        <span class="n">bond_id</span> <span class="o">=</span> <span class="n">df_tag</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="c1"># print(df_tag)  </span>
        <span class="k">if</span> <span class="s1">&#39;1001&#39;</span> <span class="ow">in</span> <span class="n">df_tag</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;1003&#39;</span> <span class="ow">in</span> <span class="n">df_tag</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span> <span class="p">:</span>
            <span class="c1"># 判断交易日之后是否存在行权日</span>
            <span class="n">sql_query_exercise</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;SELECT exercise_date FROM rd_bond_exercise_info WHERE bond_id = &quot;</span><span class="si">%s</span><span class="s1">&quot; AND is_deleted = 0 AND exercise_date &gt;= &#39;</span><span class="si">%s</span><span class="s1">&#39; ORDER BY exercise_date ASC LIMIT 1&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bond_id</span><span class="p">,</span> <span class="n">traded_date</span><span class="p">)</span>
            <span class="n">e_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sql_query_exercise</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rdcon</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e_date</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                
                <span class="n">normal_data</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">YTM_coupon_bond_normal</span><span class="p">(</span><span class="n">bond_code</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">traded_date</span><span class="p">)</span>
                <span class="n">YTM_normal</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">normal_data</span><span class="p">[</span><span class="s1">&#39;到期收益率&#39;</span><span class="p">],</span><span class="mi">4</span><span class="p">)</span>
            
                <span class="n">exercise_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">YTM_coupon_bond_exercise</span><span class="p">(</span><span class="n">bond_code</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">traded_date</span><span class="p">)</span>
                <span class="n">YTM_exercise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">exercise_data</span><span class="p">[</span><span class="s1">&#39;行权收益率&#39;</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ChainMap</span><span class="p">(</span><span class="n">normal_data</span><span class="p">,</span> <span class="n">exercise_data</span><span class="p">))</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;到期收益率</span><span class="si">{</span><span class="n">YTM_normal</span><span class="si">}</span><span class="s1">%, 行权收益率</span><span class="si">{</span><span class="n">YTM_exercise</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span> 
        <span class="k">else</span><span class="p">:</span>  
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">YTM_coupon_bond_normal</span><span class="p">(</span><span class="n">bond_code</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">traded_date</span><span class="p">)</span>
            <span class="n">YTM_normal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;到期收益率&#39;</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;到期收益率</span><span class="si">{</span><span class="n">YTM_coupon_bond_normal</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span></div>

        
        <span class="c1"># 计算行权收益率</span>
<div class="viewcode-block" id="BondCalculator.YTM_coupon_bond_exercise">
<a class="viewcode-back" href="../BondCalculator.html#BondCalculator.BondCalculator.YTM_coupon_bond_exercise">[文档]</a>
    <span class="k">def</span> <span class="nf">YTM_coupon_bond_exercise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bond_code</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">traded_date</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        **介绍:**</span>
<span class="sd">            计算债券在交易日最近一个行权日的到期收益率（YTM）。</span>

<span class="sd">            该函数接受三个参数：bond_code、price 和 traded_date。</span>
<span class="sd">            它查询数据库以获取与债券相关的现金流和行权信息。</span>
<span class="sd">            计算前一个和下一个支付日期、应付利息和总价格。</span>
<span class="sd">            确定交易日期后的第一个行权日期，并计算应付利息和本金。</span>
<span class="sd">            嵌套函数使用牛顿法计算基于现金流的YTM。</span>
<span class="sd">            </span>
<span class="sd">            使用方法与YTM_coupon_bond完全相同</span>
<span class="sd">        </span>
<span class="sd">        **重要:**: </span>
<span class="sd">            行权债才能单独使用,否则会抛出错误</span>

<span class="sd">        参数:</span>
<span class="sd">            bond_code (str): 债券代码。</span>
<span class="sd">            price (float): 交易日净价。</span>
<span class="sd">            traded_date (str): 债券的交易日，格式为 &#39;YYYY-MM-DD&#39;。</span>

<span class="sd">        返回:</span>
<span class="sd">            dict: 包含行权收益率（YTM）、行权日和行权信息的字典。</span>

<span class="sd">        抛出:</span>
<span class="sd">            ValueError: 没有找到合适的行权日期。</span>
<span class="sd">            </span>
<span class="sd">        用法:</span>
<span class="sd">            &gt;&gt;&gt;    from BondCalculator import BondCalculator as bc</span>
<span class="sd">            &gt;&gt;&gt;    object = bc()</span>
<span class="sd">            &gt;&gt;&gt;    bond_code = &#39;152961.SH&#39;</span>
<span class="sd">            &gt;&gt;&gt;    price = 84.63</span>
<span class="sd">            &gt;&gt;&gt;    traded_date = &#39;2024-7-25&#39;</span>
<span class="sd">            &gt;&gt;&gt;    file_path = &#39;/Users/mac/Desktop/YY/收益率脚本/YTM_2024_8_23.xlsx&#39;</span>
<span class="sd">            &gt;&gt;&gt;    sheet_YTM = &#39;YTM&#39;</span>
<span class="sd">            &gt;&gt;&gt;    sheet_cash_flow = &#39;cash_flow&#39;</span>
<span class="sd">            &gt;&gt;&gt;    ytm = object.YTM_coupon_bond_exercise(bond_code, price, traded_date)</span>
<span class="sd">            return {</span>
<span class="sd">            &#39;行权收益率&#39;: 2.3218890242845047,</span>
<span class="sd">            &#39;行权日&#39;: datetime.date(2026, 7, 21),</span>
<span class="sd">            &#39;行权信息&#39;:    level_0  index exercise_date  exercise_type</span>
<span class="sd">            0        0      0    2026-07-21           1001}</span>

<span class="sd">        &#39;&#39;&#39;</span>
        
        
        <span class="n">traded_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">traded_date</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="c1"># 查看现金流计划</span>
        <span class="n">sql_query_cf</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;SELECT c.cash_flow,  c.value_date, c.interest_payable, c.principal_payable, c.cash_flow_type, c.couponrate, b.id, b.tag, b.bond_code FROM rd_bond_cash_flow  c LEFT JOIN rd_bond b ON b.id = c.bond_id WHERE b.bond_code = &quot;</span><span class="si">%s</span><span class="s1">&quot; AND b.is_deleted = 0 &#39;&#39;&#39;</span><span class="o">%</span> <span class="n">bond_code</span>
        <span class="n">df_cf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sql_query_cf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rdcon</span><span class="p">)</span>
        <span class="n">df_cf</span> <span class="o">=</span><span class="n">df_cf</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="s1">&#39;value_date&#39;</span><span class="p">,</span> <span class="n">ascending</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">bond_id</span> <span class="o">=</span> <span class="n">df_cf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="c1"># 获取债券ID</span>
        
        <span class="c1"># 查看回售赎回计划</span>
        <span class="n">sql_query_ec</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;SELECT exercise_date, exercise_type</span>
<span class="s1">        FROM rd_bond_exercise_info</span>
<span class="s1">        WHERE (exercise_type = 1001 OR exercise_type = 1003)</span>
<span class="s1">        AND bond_id = &quot;</span><span class="si">%s</span><span class="s1">&quot;</span>
<span class="s1">        AND is_deleted = 0&#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">bond_id</span>
        <span class="n">exercise_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sql_query_ec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rdcon</span><span class="p">)</span>
        <span class="n">exercise_info</span> <span class="o">=</span>  <span class="n">exercise_info</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s1">&#39;exercise_date&#39;</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span> <span class="c1"># 保留不重复的行权日期</span>
        <span class="n">exercise_info</span> <span class="o">=</span> <span class="n">exercise_info</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;exercise_date&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="c1"># exercise_date =  exercise_info.iloc[1][&#39;exercise_date&#39;] # 选择首期行权日 </span>
        
        <span class="n">yearlenth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_cf</span><span class="p">)</span> <span class="c1"># 获取正常现金流计息年限 </span>
        <span class="n">schedule</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_cf</span><span class="p">[</span><span class="s1">&#39;value_date&#39;</span><span class="p">])</span> <span class="c1"># 获取付息计划</span>

        <span class="c1"># 计算traded_date 在哪两个交易日之间 求出截至交易日的应付利息 计算全价</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">yearlenth</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">df_cf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;value_date&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">traded_date</span><span class="p">:</span> 
                <span class="n">idx</span> <span class="o">=</span> <span class="n">i</span> 
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sql_query_date</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;select value_date from rd_bond where bond_code = &#39;</span><span class="si">%s</span><span class="s1">&#39; &#39;&#39;&#39;</span><span class="o">%</span> <span class="n">bond_code</span>
            <span class="n">df_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sql_query_date</span><span class="p">,</span> <span class="n">rdcon</span><span class="p">)</span>
            <span class="n">previous_value_date</span> <span class="o">=</span> <span class="n">df_date</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;value_date&#39;</span><span class="p">]</span> <span class="c1"># 下一计息日</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">previous_value_date</span> <span class="o">=</span> <span class="n">df_cf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;value_date&#39;</span><span class="p">]</span>
        <span class="n">next_value_date</span> <span class="o">=</span> <span class="n">df_cf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;value_date&#39;</span><span class="p">]</span> <span class="c1"># 下一计息日</span>
        
        <span class="n">days_between</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_value_date</span> <span class="o">-</span> <span class="n">previous_value_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> 
        <span class="n">days_since_previous</span> <span class="o">=</span> <span class="p">(</span><span class="n">traded_date</span> <span class="o">-</span> <span class="n">previous_value_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1"># 包括交易日 </span>
        
        <span class="n">AI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">days_since_previous</span> <span class="o">/</span> <span class="n">days_between</span><span class="p">)</span> <span class="o">*</span> <span class="n">df_cf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;interest_payable&#39;</span><span class="p">],</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">PV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">AI</span> <span class="o">+</span> <span class="n">price</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;上一付息日：</span><span class="si">{</span><span class="n">previous_value_date</span><span class="si">}</span><span class="s1"> 下一付息日：</span><span class="si">{</span><span class="n">next_value_date</span><span class="si">}</span><span class="s1"> 应付利息：</span><span class="si">{</span><span class="n">AI</span><span class="si">}</span><span class="s1"> 全价: </span><span class="si">{</span><span class="n">PV</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        
        <span class="n">exerlenth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">exercise_info</span><span class="p">)</span>
        <span class="c1"># 寻找交易日后第一个行权日</span>
        <span class="n">exercise_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">exerlenth</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">exercise_info</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;exercise_date&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">traded_date</span><span class="p">:</span>
                <span class="n">exercise_date</span> <span class="o">=</span> <span class="n">exercise_info</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;exercise_date&#39;</span><span class="p">]</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">exercise_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;没有找到合适的行权日期&quot;</span><span class="p">)</span>

        <span class="c1"># 行权日后的的第一个付息日</span>
        <span class="k">for</span>  <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">yearlenth</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">df_cf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;value_date&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">exercise_date</span><span class="p">:</span>
                <span class="n">idx_exercise</span> <span class="o">=</span> <span class="n">j</span>
                <span class="k">break</span>
            
        <span class="c1"># 行权日所在付息周期  截至行权日应付利息</span>
        <span class="k">if</span> <span class="n">idx_exercise</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sql_query_date</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;select value_date from rd_bond where bond_code = &#39;</span><span class="si">%s</span><span class="s1">&#39; &#39;&#39;&#39;</span><span class="o">%</span> <span class="n">bond_code</span>
            <span class="n">df_date2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sql_query_date</span><span class="p">,</span> <span class="n">rdcon</span><span class="p">)</span>
            <span class="n">previous_value_date2</span> <span class="o">=</span> <span class="n">df_date2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;value_date&#39;</span><span class="p">]</span> <span class="c1"># 上一计息日</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">previous_value_date2</span> <span class="o">=</span> <span class="n">df_cf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx_exercise</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;value_date&#39;</span><span class="p">]</span>
        <span class="n">next_value_date2</span> <span class="o">=</span> <span class="n">df_cf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx_exercise</span><span class="p">][</span><span class="s1">&#39;value_date&#39;</span><span class="p">]</span> <span class="c1"># 下一计息日</span>
        
        <span class="n">days_between2</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_value_date2</span> <span class="o">-</span> <span class="n">previous_value_date2</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
        <span class="n">days_since_previous2</span> <span class="o">=</span> <span class="p">(</span><span class="n">exercise_date</span> <span class="o">-</span> <span class="n">previous_value_date2</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> 
        <span class="n">survival_interest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">days_since_previous2</span> <span class="o">/</span> <span class="n">days_between2</span><span class="p">)</span><span class="o">*</span><span class="n">df_cf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx_exercise</span><span class="p">][</span><span class="s1">&#39;interest_payable&#39;</span><span class="p">],</span> <span class="mi">6</span><span class="p">)</span> <span class="c1"># 行权周期应付利息</span>
        <span class="n">interest</span> <span class="o">=</span> <span class="n">df_cf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx_exercise</span><span class="p">][</span><span class="s1">&#39;interest_payable&#39;</span><span class="p">]</span>
        <span class="c1"># 行权周期应付本金</span>
        <span class="n">payable_principal</span> <span class="o">=</span> <span class="n">df_cf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="n">idx_exercise</span><span class="p">][</span><span class="s1">&#39;principal_payable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> 
        <span class="n">survival_principal</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="n">payable_principal</span> 
        
        <span class="c1"># 打印行权调试信息</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;行权日上一计息日:</span><span class="si">{</span><span class="n">previous_value_date2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;行权日下一计息日:</span><span class="si">{</span><span class="n">next_value_date2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;days_since_previous2:</span><span class="si">{</span><span class="n">days_since_previous2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;days_between2:</span><span class="si">{</span><span class="n">days_between2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;行权日：</span><span class="si">{</span><span class="n">exercise_date</span><span class="si">}</span><span class="s1"> 行权周期应付利息:</span><span class="si">{</span><span class="n">survival_interest</span><span class="si">}</span><span class="s1"> 行权周期应付本金：</span><span class="si">{</span><span class="n">survival_principal</span><span class="si">}</span><span class="s1">行权日下一现金流利息支出:</span><span class="si">{</span><span class="n">interest</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># 生成现金流计划</span>
        <span class="k">def</span> <span class="nf">ytm_function</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
            <span class="n">total_pv</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">idx_exercise</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">idx_exercise</span><span class="p">:</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">exercise_date</span> <span class="o">-</span> <span class="n">traded_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">/</span> <span class="mi">365</span>
                    <span class="n">cash_flow</span> <span class="o">=</span> <span class="n">survival_principal</span> <span class="o">+</span> <span class="n">survival_interest</span>
                    <span class="n">total_pv</span> <span class="o">+=</span> <span class="n">cash_flow</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="n">t</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">schedule</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span> <span class="o">-</span> <span class="n">traded_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">/</span> <span class="mi">365</span>
                    <span class="n">cash_flow</span> <span class="o">=</span> <span class="n">df_cf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;cash_flow&#39;</span><span class="p">]</span>
                    <span class="n">total_pv</span> <span class="o">+=</span> <span class="n">cash_flow</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="n">t</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">total_pv</span> <span class="o">-</span> <span class="n">PV</span>
        <span class="n">YTM</span> <span class="o">=</span> <span class="n">newton</span><span class="p">(</span><span class="n">ytm_function</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>
        <span class="n">df_cf</span> <span class="o">=</span> <span class="n">df_cf</span><span class="p">[</span><span class="n">idx</span><span class="p">:</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;行权收益率&quot;</span><span class="p">:</span><span class="n">YTM</span><span class="p">,</span> <span class="s1">&#39;行权日&#39;</span><span class="p">:</span><span class="n">exercise_date</span><span class="p">,</span> <span class="s1">&#39;行权信息&#39;</span><span class="p">:</span><span class="n">exercise_info</span><span class="p">}</span></div>


<div class="viewcode-block" id="BondCalculator.YTM_coupon_bond_normal">
<a class="viewcode-back" href="../BondCalculator.html#BondCalculator.BondCalculator.YTM_coupon_bond_normal">[文档]</a>
    <span class="k">def</span> <span class="nf">YTM_coupon_bond_normal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bond_code</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">traded_date</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **介绍:**</span>
<span class="sd">            根据债券的现金流和交易日计算到期收益率（YTM）。</span>

<span class="sd">            此函数检索指定债券的现金流数据，计算应计利息，并确定债券的全价和到期收益率。</span>
<span class="sd">            </span>
<span class="sd">            使用方法与YTM_coupon_bond_normal一致,可以单独使用计算完整现金流到期收益率</span>

<span class="sd">        参数:</span>
<span class="sd">            bond_code (str): 债券的唯一标识符。</span>
<span class="sd">            price (float): 债券的市场价格。</span>
<span class="sd">            traded_date (str): 债券交易日期，格式为 &#39;YYYY-MM-DD&#39;。</span>

<span class="sd">        返回类型:</span>
<span class="sd">            dict: 包含计算得到的 YTM、现金流 DataFrame、应计利息和债券全价的字典。</span>

<span class="sd">        抛出:</span>
<span class="sd">            ValueError: 如果交易日期无效或债券代码在数据库中不存在。</span>
<span class="sd">            </span>
<span class="sd">        用法：</span>
<span class="sd">            &gt;&gt;&gt;    from BondCalculator import BondCalculator as bc</span>
<span class="sd">            &gt;&gt;&gt;    object = bc()</span>
<span class="sd">            &gt;&gt;&gt;    bond_code = &#39;152961.SH&#39;</span>
<span class="sd">            &gt;&gt;&gt;    price = 84.63</span>
<span class="sd">            &gt;&gt;&gt;    traded_date = &#39;2024-7-25&#39;</span>
<span class="sd">            &gt;&gt;&gt;    file_path = &#39;/Users/mac/Desktop/YY/收益率脚本/YTM_2024_8_23.xlsx&#39;</span>
<span class="sd">            &gt;&gt;&gt;    sheet_YTM = &#39;YTM&#39;</span>
<span class="sd">            &gt;&gt;&gt;    sheet_cash_flow = &#39;cash_flow&#39;</span>
<span class="sd">            &gt;&gt;&gt;    ytm = object.YTM_coupon_bond_exercise(bond_code, price, traded_date)</span>
<span class="sd">            return</span>
<span class="sd">                {</span>
<span class="sd">                &#39;到期收益率&#39;: 35.695510535908966,</span>
<span class="sd">                &#39;现金流&#39;: ·······，</span>
<span class="sd">                &#39;应付利息&#39;: 0.944754,</span>
<span class="sd">                &#39;全价&#39;: 85.574754</span>
<span class="sd">                }    </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 将交易时间可运算对象</span>
        <span class="n">traded_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">traded_date</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">traded_date</span><span class="p">))</span>
        <span class="c1"># 获取现金流量表,rd_bond_cash_flow 和 rd_bond 联表</span>
        <span class="n">sql_query_cf</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;SELECT b.bond_code, c.cash_flow, c.id as cash_flow_id, c.value_date, c.couponrate,  c.interest_payable, c.principal_payable, c.cash_flow_type,  b.id as bond_id, b.tag</span>
<span class="s1">                        FROM rd_bond_cash_flow  c </span>
<span class="s1">                        LEFT JOIN rd_bond b ON b.id = c.bond_id </span>
<span class="s1">                        WHERE b.bond_code = &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">bond_code</span> 
        <span class="n">df_cf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">sql_query_cf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rdcon</span><span class="p">)</span>

        <span class="c1"># 排序rd，</span>
        <span class="n">df_cf</span> <span class="o">=</span> <span class="n">df_cf</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;value_date&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">df_cf</span><span class="p">)</span>
        
        <span class="c1"># 生成付息计划</span>
        <span class="n">yearlenth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_cf</span><span class="p">)</span>              <span class="c1"># 获取计息年限</span>
        <span class="n">schedule</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_cf</span><span class="p">[</span><span class="s1">&#39;value_date&#39;</span><span class="p">])</span>

        <span class="c1"># 计算traded_date 在哪两个交易日之间</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">yearlenth</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">df_cf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;value_date&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">traded_date</span><span class="p">:</span> 
                <span class="n">idx</span> <span class="o">=</span> <span class="n">i</span> 
                <span class="k">break</span>
        <span class="n">next_value_date</span> <span class="o">=</span> <span class="n">df_cf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;value_date&#39;</span><span class="p">]</span> <span class="c1"># 下一计息日</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sql_query_date</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;select value_date from rd_bond where bond_code = &#39;</span><span class="si">%s</span><span class="s1">&#39; &#39;&#39;&#39;</span><span class="o">%</span> <span class="n">bond_code</span>
            <span class="n">df_date</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sql_query_date</span><span class="p">,</span> <span class="n">rdcon</span><span class="p">)</span>
            <span class="n">previous_value_date</span> <span class="o">=</span> <span class="n">df_date</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;value_date&#39;</span><span class="p">]</span> <span class="c1"># 上一计息日</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">previous_value_date</span> <span class="o">=</span> <span class="n">df_cf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;value_date&#39;</span><span class="p">]</span>
        
        <span class="n">days_between</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_value_date</span> <span class="o">-</span> <span class="n">previous_value_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
        <span class="n">days_since_previous</span> <span class="o">=</span> <span class="p">(</span><span class="n">traded_date</span> <span class="o">-</span> <span class="n">previous_value_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="mi">1</span> 
        <span class="c1"># 应计利息 包括交易日</span>
        <span class="c1"># 应计利息  </span>
        <span class="n">AI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">days_since_previous</span> <span class="o">/</span> <span class="n">days_between</span><span class="p">)</span> <span class="o">*</span> <span class="n">df_cf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;interest_payable&#39;</span><span class="p">],</span> <span class="mi">6</span><span class="p">)</span>

        <span class="c1"># 打印调试信息</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;previous_value_date: </span><span class="si">{</span><span class="n">previous_value_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;next_value_date: </span><span class="si">{</span><span class="n">next_value_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;traded_date: </span><span class="si">{</span><span class="n">traded_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;days_between: </span><span class="si">{</span><span class="n">days_between</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;days_since_previous: </span><span class="si">{</span><span class="n">days_since_previous</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cash_flow: </span><span class="si">{</span><span class="n">df_cf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;cash_flow&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;accured_principal: </span><span class="si">{</span><span class="n">AI</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
        
        <span class="c1">## 计算全价</span>
        <span class="n">PV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">AI</span> <span class="o">+</span> <span class="n">price</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;全价: </span><span class="si">{</span><span class="n">PV</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="c1"># 判断不处于最后一个付息周期</span>
        <span class="k">if</span> <span class="n">traded_date</span> <span class="o">&lt;</span> <span class="n">schedule</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;交易日 </span><span class="si">{</span><span class="n">traded_date</span><span class="si">}</span><span class="s1"> 不在最后一个付息周期&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">ytm_function</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
            <span class="n">total_pv</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">cf</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">schedule</span><span class="p">[</span><span class="n">idx</span><span class="p">:],</span> <span class="n">df_cf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">:][</span><span class="s1">&#39;cash_flow&#39;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="n">schedule</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">total_pv</span> <span class="o">+=</span> <span class="n">cf</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="p">(((</span><span class="n">d</span> <span class="o">-</span> <span class="n">traded_date</span> <span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">365</span><span class="p">))</span> <span class="c1"># 算头不算尾？</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">total_pv</span> <span class="o">+=</span> <span class="n">cf</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="p">((</span><span class="n">d</span> <span class="o">-</span> <span class="n">traded_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">/</span> <span class="mi">365</span><span class="p">))</span>
                

            <span class="k">return</span> <span class="n">total_pv</span> <span class="o">-</span> <span class="n">PV</span>
        <span class="c1">#    使用 SciPy 的 optimize.newton 方法求解</span>
        <span class="n">YTM</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">newton</span><span class="p">(</span><span class="n">ytm_function</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span> <span class="o">*</span><span class="mi">100</span> <span class="c1"># 使用5%作为初始猜测值</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;到期收益率&quot;</span><span class="p">:</span><span class="n">YTM</span><span class="p">,</span> <span class="s2">&quot;现金流&quot;</span><span class="p">:</span><span class="n">df_cf</span><span class="p">,</span> <span class="s2">&quot;应付利息&quot;</span><span class="p">:</span><span class="n">AI</span><span class="p">,</span> <span class="s2">&quot;全价&quot;</span><span class="p">:</span><span class="n">PV</span><span class="p">}</span></div>

        
<div class="viewcode-block" id="BondCalculator.process_data">
<a class="viewcode-back" href="../BondCalculator.html#BondCalculator.BondCalculator.process_data">[文档]</a>
    <span class="k">def</span> <span class="nf">process_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bond_code</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">traded_date</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">sheet_YTM</span><span class="p">,</span> <span class="n">sheet_cash_flow</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        **介绍：**</span>
<span class="sd">            这段代码定义了一个名为 process_data 的方法，用于处理与债券相关的金融数据，并将其附加到现有的 Excel 文件中。它检索指定债券的到期收益率（YTM）和现金流数据，将这些数据组织成结构化格式，并写入指定的工作表。</span>
<span class="sd">        </span>
<span class="sd">        **重要：**</span>
<span class="sd">            1.这个函数并不返回数据，而将数据写入文件路径</span>
<span class="sd">            2.**支持不同债券数据重复使用，可将数据一并添加到一个Excel文件，及两个工作表sheet_YTM和sheet_cash_flow**</span>
<span class="sd">        </span>
<span class="sd">        参数:</span>
<span class="sd">            bond_code (str): 债券代码。</span>
<span class="sd">            price (float): 交易日净价。</span>
<span class="sd">            traded_date (str): 债券的交易日，格式为 &#39;YYYY-MM-DD&#39;。</span>
<span class="sd">            file_path (str): 要追加数据的 Excel 文件路径。</span>
<span class="sd">            sheet_YTM (str): 存储 YTM 数据的 Excel 工作表名称。</span>
<span class="sd">            sheet_cash_flow (str): 存储现金流数据的 Excel 工作表名称。</span>

<span class="sd">        抛出:</span>
<span class="sd">            Exception: 如果在处理数据时发生错误。</span>

<span class="sd">        返回类型:</span>
<span class="sd">            None</span>
<span class="sd">            </span>
<span class="sd">        用法:</span>
<span class="sd">            &gt;&gt;&gt; from BondCalculator import BondCalculator as bc # 导入文件</span>
<span class="sd">            &gt;&gt;&gt; object = bc() #  实例化 </span>
<span class="sd">            &gt;&gt;&gt; bond_code = &#39;152961.SH&#39;</span>
<span class="sd">            &gt;&gt;&gt; price = 84.63</span>
<span class="sd">            &gt;&gt;&gt; traded_date = &#39;2024-7-25&#39;</span>
<span class="sd">            &gt;&gt;&gt; file_path = &#39;/Users/mac/Desktop/YY/收益率脚本/YTM_2024_8_23.xlsx&#39;</span>
<span class="sd">            &gt;&gt;&gt; sheet_YTM = &#39;YTM&#39;</span>
<span class="sd">            &gt;&gt;&gt; sheet_cash_flow = &#39;cash_flow&#39;# 定义参数</span>
<span class="sd">            </span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="c1"># 检查是否创建了文件，如果没有自行创建</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;openpyxl&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="n">sheet_YTM</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="n">sheet_cash_flow</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># 读取收益率，现金流等数据</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">YTM_coupon_bond</span><span class="p">(</span><span class="n">bond_code</span><span class="p">,</span> <span class="n">price</span><span class="p">,</span> <span class="n">traded_date</span><span class="p">)</span>

            <span class="c1"># 创建变量存储现金流和债券其他数据</span>
            <span class="n">cash_flow</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;现金流&#39;</span><span class="p">]</span>
            <span class="n">exercise_info</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;行权信息&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;行权信息&#39;</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">bond_YTM</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;债券代码&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">bond_code</span><span class="p">],</span> <span class="s1">&#39;交易日&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">traded_date</span><span class="p">],</span> <span class="s1">&#39;成交净价&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">price</span><span class="p">]}</span>
            <span class="n">bond_YTM</span><span class="p">[</span><span class="s1">&#39;到期收益率&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;到期收益率&#39;</span><span class="p">]]</span>
            <span class="n">bond_YTM</span><span class="p">[</span><span class="s1">&#39;行权收益率&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;行权收益率&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;行权收益率&#39;</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">else</span> <span class="s1">&#39;不行权或行权日在交易日前&#39;</span><span class="p">]</span>
            <span class="n">bond_YTM</span><span class="p">[</span><span class="s1">&#39;应付利息&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;应付利息&#39;</span><span class="p">]]</span>
            <span class="n">bond_YTM</span><span class="p">[</span><span class="s1">&#39;全价&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;全价&#39;</span><span class="p">]]</span>
            <span class="n">bond_YTM</span><span class="p">[</span><span class="s1">&#39;行权日&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;行权日&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;行权日&#39;</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">else</span> <span class="s1">&#39;无&#39;</span><span class="p">]</span>
            <span class="n">bond_YTM</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">bond_YTM</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;债券代码&#39;</span><span class="p">,</span> <span class="s1">&#39;交易日&#39;</span><span class="p">,</span> <span class="s1">&#39;成交净价&#39;</span><span class="p">,</span> <span class="s1">&#39;到期收益率&#39;</span><span class="p">,</span> <span class="s1">&#39;行权收益率&#39;</span><span class="p">,</span> <span class="s1">&#39;应付利息&#39;</span><span class="p">,</span> <span class="s1">&#39;全价&#39;</span><span class="p">,</span> <span class="s1">&#39;行权日&#39;</span><span class="p">])</span>            
            
            <span class="c1"># 如果行权，添加行权信息</span>
            <span class="k">if</span> <span class="n">exercise_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">exercise_info</span> <span class="o">=</span> <span class="n">exercise_info</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">cash_flow</span> <span class="o">=</span> <span class="n">cash_flow</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">cash_flow</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">cash_flow</span><span class="p">,</span> <span class="n">exercise_info</span><span class="p">],</span>  <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># 读取现有的数据</span>
            <span class="n">YTM_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="n">sheet_YTM</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;openpyxl&#39;</span><span class="p">)</span>
            <span class="n">cash_flow_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="n">sheet_cash_flow</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;openpyxl&#39;</span><span class="p">)</span>
        
            <span class="c1"># 将新的数据添加到现有的数据中</span>
            <span class="n">YTM_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">YTM_data</span><span class="p">,</span> <span class="n">bond_YTM</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">cash_flow_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">cash_flow_data</span><span class="p">,</span> <span class="n">cash_flow</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># 保存到Excel文件</span>
            <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;openpyxl&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
                <span class="c1"># 将结果转换为 DataFrame 并保存到第一个工作表</span>
                <span class="n">YTM_data</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="n">sheet_YTM</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="c1"># 将所有现金流数据保存到第二个工作表</span>
                <span class="n">cash_flow_data</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="n">sheet_cash_flow</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;数据已成功追加到Excel文件中。&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;处理数据时发生错误: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
</div>



</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">到期收益率</a></h1>








<h3>导航</h3>
<p class="caption" role="heading"><span class="caption-text">目录:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../BondCalculator.html">BondCalculator module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jms_sqlconnect.html">jms_sqlconnect module</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">模块代码</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">快速搜索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="提交" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, hwccurry.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>